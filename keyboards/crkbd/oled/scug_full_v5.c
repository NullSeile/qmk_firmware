#include <avr/pgmspace.h>
#include <stdint.h>
#include "lib/lib8tion/lib8tion.h"
#include "oled_driver.h"
#include "quantum.h"
#include "timer.h"
// #include "wpm.h"

#include "custom_keys.h"

static const char PROGMEM frames[] = {
    // Frame: 0
    131,192,252,255,207,255,131,252,224,0,107,132,31,63,15,255,208,255,111,195,255,134,63,255,255,223,239,255,198,255,131,159,128,0,110,134,7,63,127,255,227,255,197,255,132,127,63,15,3,195,3,107,
    // Frame: 1
    127,127,20,194,64,130,128,0,112,133,8,0,28,8,0,7,195,2,107,
    // Frame: 2
    131,224,254,255,205,255,194,254,132,248,224,128,0,106,134,31,63,7,3,31,255,207,255,131,254,224,0,107,134,124,24,12,15,31,255,199,255,133,191,31,31,191,255,194,255,194,224,194,96,104,131,56,16,24,194,24,195,31,194,127,139,255,249,223,143,143,223,255,255,159,15,0,104,
    // Frame: 3
    2,133,224,240,248,248,252,196,252,137,248,240,224,224,192,192,128,128,0,109,132,30,15,199,255,208,255,194,254,194,252,194,248,194,240,132,224,192,128,0,98,139,7,3,15,31,63,63,31,63,127,127,255,201,255,138,207,255,125,120,248,253,255,255,63,7,194,7,130,3,0,100,138,4,20,12,12,4,4,6,7,7,3,195,3,194,7,138,6,4,4,6,15,31,29,56,16,0,94,
    // Frame: 4
    3,131,128,192,224,197,224,194,192,194,128,50,134,1,3,7,15,12,0,60,205,255,194,254,195,252,195,248,195,240,196,224,194,192,132,128,0,0,128,194,128,92,139,124,25,51,119,127,127,63,31,31,63,127,194,127,202,255,142,231,127,61,56,120,253,255,127,63,3,3,1,1,0,101,194,2,130,7,1,196,1,199,3,194,2,134,3,7,7,12,8,0,92,
    // Frame: 5
    3,131,128,0,128,202,128,46,195,1,135,51,31,15,7,3,1,0,12,131,3,1,0,44,130,243,255,213,255,194,254,140,62,238,198,198,236,248,248,252,28,14,4,0,91,132,31,15,7,15,200,15,197,31,201,63,137,59,49,17,59,127,127,231,192,0,127,91,
    // Frame: 6
    3,135,112,96,112,112,240,240,224,209,224,196,192,194,64,134,128,192,224,224,96,0,24,138,4,12,12,30,31,63,255,221,140,0,6,196,1,136,3,7,15,31,127,243,129,0,40,132,224,252,254,255,214,255,137,231,126,60,60,126,255,255,124,0,33,130,1,0,58,133,63,31,15,15,7,194,7,195,3,198,7,201,15,195,7,194,6,194,3,133,7,6,14,12,0,127,76,134,192,224,112,24,8,0,7,
    // Frame: 7
    3,134,60,56,24,152,216,248,195,248,199,240,197,248,198,240,138,176,16,16,160,240,240,184,28,12,0,24,137,96,227,255,255,254,248,240,96,0,5,194,4,194,14,194,255,133,63,15,6,6,0,42,132,224,248,254,255,214,255,139,249,223,143,143,223,255,255,223,192,128,0,26,134,56,31,7,3,1,0,9,194,3,48,194,127,133,63,31,15,15,7,195,7,200,3,203,1,3,194,1,194,3,127,74,137,134,158,248,240,224,192,128,128,0,7,
    // Frame: 8
    3,130,2,4,199,4,194,8,3,194,8,2,195,4,195,12,195,8,139,104,152,152,120,0,0,64,100,116,104,96,195,96,131,224,160,0,17,140,96,227,255,255,126,56,48,128,240,56,24,0,2,194,4,194,14,140,239,199,7,55,122,248,254,127,123,113,96,0,63,137,6,51,72,72,48,0,0,32,0,27,139,3,59,24,8,12,30,63,127,231,131,0,5,194,3,5,134,3,7,14,24,16,0,37,130,128,0,2,130,16,0,2,194,4,5,195,2,130,0,1,201,1,42,194,1,127,34,195,128,139,102,126,0,12,28,62,95,67,192,128,0,5,
    // Frame: 9
    3,134,60,56,24,152,216,248,195,248,207,240,196,224,133,160,0,0,160,224,195,224,199,96,195,224,130,160,0,16,133,24,112,224,128,0,25,194,128,32,132,224,248,254,255,215,255,136,249,223,143,143,223,63,1,3,194,3,27,136,134,230,127,63,15,6,6,0,11,130,14,30,194,30,138,220,252,60,62,54,3,3,1,1,0,31,194,127,133,63,31,15,15,7,195,7,200,3,198,1,196,3,194,1,194,7,131,15,14,0,29,130,3,0,20,132,48,60,15,0,16,194,12,134,24,48,96,192,128,0,120,138,24,28,30,14,15,103,255,7,3,0,9,
    // Frame: 10
    3,134,60,56,24,152,216,248,195,248,207,240,196,224,133,96,32,32,64,192,201,192,197,128,23,131,192,224,0,11,130,96,224,195,224,132,196,140,252,0,35,132,224,248,254,255,215,255,135,243,191,30,30,191,127,3,196,3,3,196,1,194,2,17,136,16,56,120,248,252,63,51,0,12,194,24,133,8,13,13,7,3,195,3,34,194,127,133,63,31,15,15,7,195,7,200,3,198,1,196,3,194,1,195,7,131,6,2,0,31,132,7,15,24,0,43,133,128,224,124,30,0,117,139,48,112,120,120,124,62,115,249,216,128,0,6,
    // Frame: 11
    41,196,64,197,128,16,130,128,0,5,131,192,224,0,11,143,96,248,152,152,144,52,236,28,224,176,48,24,28,12,0,67,194,1,130,3,2,194,2,132,6,5,3,0,14,138,192,227,239,196,136,56,60,63,51,0,12,194,24,134,8,13,15,120,3,2,194,2,94,139,32,48,28,14,3,1,0,7,15,24,0,35,194,12,139,24,48,96,192,128,0,128,224,124,30,0,115,141,24,28,46,126,119,31,131,57,112,249,216,128,0,6,
    // Frame: 12
    37,195,64,130,192,128,195,128,21,130,128,0,20,142,24,102,102,76,76,153,159,28,80,112,24,28,12,0,66,139,4,6,7,5,13,15,31,27,3,1,0,14,136,192,99,31,28,128,216,192,0,14,194,12,134,6,3,1,126,0,1,194,1,19,130,128,0,31,198,2,36,138,38,55,27,9,28,63,118,224,128,0,36,194,12,136,152,240,160,56,127,195,192,0,117,142,7,23,19,25,13,14,100,248,1,15,24,48,96,0,6,
    // Frame: 13
    3,134,60,56,24,152,216,248,195,248,206,240,198,224,194,64,195,192,130,128,0,49,142,24,120,120,112,240,96,224,224,176,48,24,28,12,0,29,132,224,248,254,255,215,255,146,231,126,60,60,126,255,7,15,15,31,24,48,48,96,224,192,64,0,11,130,128,0,30,132,2,127,0,1,194,1,7,194,48,194,96,194,192,130,128,0,19,194,127,133,63,31,15,15,7,195,7,211,3,131,2,6,7,194,7,130,3,0,5,194,1,194,3,11,134,129,199,222,252,240,192,194,192,38,130,48,112,194,112,135,48,63,127,252,140,12,0,71,194,1,133,121,61,15,1,0,46,194,127,14,
    // Frame: 14
    87,143,96,248,152,152,144,52,236,28,224,176,48,24,28,12,0,62,140,56,48,112,104,120,240,240,224,96,192,64,0,11,130,128,0,26,194,24,134,8,13,15,120,3,2,194,2,7,194,48,194,224,194,192,135,128,0,224,124,31,3,0,53,194,1,194,2,131,6,3,0,10,134,129,199,222,252,240,192,194,192,133,0,128,224,56,0,33,130,55,119,194,119,137,55,48,112,227,123,203,7,3,0,69,194,1,138,121,37,23,29,28,60,127,239,141,0,41,194,127,131,15,14,0,11,
    // Frame: 15
    87,130,96,224,195,224,136,196,140,252,0,0,128,128,0,9,194,128,103,142,14,6,6,22,209,241,59,61,53,0,0,1,1,0,5,140,96,240,112,240,225,225,227,30,128,223,3,0,75,136,64,128,128,0,128,224,56,0,17,132,48,60,15,0,11,142,8,15,11,11,3,1,8,12,31,247,199,7,3,0,72,194,24,138,28,60,13,76,209,115,248,24,24,0,40,131,15,14,0,11,
    // Frame: 16
    97,194,128,8,139,128,0,128,128,0,0,128,224,124,14,0,93,195,128,142,206,222,157,225,32,124,188,62,54,3,3,1,1,0,5,140,96,119,247,247,239,239,237,0,3,205,12,0,75,132,64,128,128,0,6,131,128,64,0,6,139,1,35,51,51,27,15,63,59,12,3,0,10,194,8,194,12,135,4,6,27,15,7,1,0,78,139,32,49,51,14,142,136,32,228,191,51,0,52,
    // Frame: 17
    3,134,60,56,24,152,216,248,195,248,207,240,196,224,138,96,32,32,96,224,224,192,192,128,0,66,197,224,134,195,255,240,192,128,0,13,132,224,248,254,255,215,255,147,243,191,30,30,191,127,7,15,15,31,24,56,48,112,112,224,160,32,0,40,133,128,192,224,96,0,11,136,16,24,24,12,12,4,7,1,196,1,14,194,127,133,63,31,15,15,7,195,7,200,3,198,1,196,3,194,1,195,7,130,6,0,27,194,128,13,140,24,56,56,120,120,56,56,60,254,219,25,0,102,136,113,115,126,252,248,48,48,0,15,131,15,12,0,36,
    // Frame: 18
    35,194,32,194,64,130,128,0,66,142,224,248,220,220,216,251,7,8,188,190,55,3,1,0,43,141,8,16,16,0,32,0,64,0,0,208,144,32,0,40,133,128,192,224,96,0,11,141,16,24,24,12,12,4,7,1,2,6,63,49,0,75,194,128,2,132,128,192,96,0,5,194,192,140,216,249,251,190,166,192,216,252,62,91,25,0,100,138,24,28,109,77,129,39,225,48,48,0,5,194,3,134,51,49,29,15,7,1,194,1,131,15,12,0,36,
    // Frame: 19
    34,130,32,0,71,142,224,248,220,220,216,251,7,8,188,190,55,3,1,0,43,141,8,24,24,16,52,32,104,72,0,64,0,16,0,40,194,192,14,141,16,24,24,12,12,4,7,1,2,6,63,49,0,68,137,130,198,220,248,248,224,128,128,0,2,132,128,192,96,0,5,141,192,64,64,1,3,6,30,56,24,28,7,3,0,95,142,96,57,29,31,15,3,25,29,28,62,255,219,25,0,9,137,48,50,30,12,6,14,56,240,0,38,
    // Frame: 20
    34,130,32,0,71,130,96,224,195,224,134,195,127,16,188,142,0,45,142,2,6,4,4,8,11,22,22,52,108,108,44,20,0,12,134,128,192,192,48,16,0,22,194,192,14,141,16,31,31,11,2,10,9,255,254,12,13,1,0,67,138,24,158,218,35,7,97,224,128,128,0,11,141,8,152,176,32,0,64,192,192,248,220,199,131,0,19,133,28,12,7,1,0,71,137,96,57,28,28,8,5,13,1,0,10,141,24,60,63,29,157,236,124,12,6,8,59,241,0,38,
    // Frame: 21
    35,134,32,0,64,0,128,0,15,131,192,128,0,48,139,128,0,128,128,0,0,128,224,124,14,0,49,194,4,136,13,9,11,27,27,25,4,0,6,140,96,113,119,127,254,252,240,240,192,48,16,0,22,194,192,14,140,96,119,247,247,239,239,237,0,3,205,12,0,68,135,6,27,31,254,255,153,0,14,141,136,152,176,32,0,64,192,192,248,220,199,131,0,13,194,8,194,12,135,4,6,27,15,7,1,0,73,134,1,3,7,6,12,0,11,141,24,63,63,25,157,236,124,12,6,8,59,241,0,38,
    // Frame: 22
    40,194,128,131,192,128,192,195,192,130,64,0,6,131,192,128,0,2,194,192,133,240,48,24,8,0,41,194,128,52,194,2,3,194,2,196,6,131,4,1,0,6,140,96,113,113,120,249,235,79,79,230,192,128,0,22,194,192,14,140,96,240,112,240,225,225,227,30,128,223,3,0,46,194,8,20,133,30,7,3,1,0,4,130,1,0,10,195,64,138,1,3,6,30,56,24,28,7,3,0,13,142,8,15,11,11,3,1,8,12,31,247,199,7,3,0,88,140,3,0,4,48,50,30,12,6,14,56,240,0,24,131,15,14,0,11,
    // Frame: 23
    31,133,192,32,32,192,0,2,130,64,96,194,96,131,32,224,160,194,160,132,32,176,48,0,10,194,192,136,48,240,215,214,248,224,128,0,87,135,10,96,145,145,96,64,0,3,200,1,9,130,6,7,194,7,135,39,99,234,206,135,3,1,194,1,19,133,128,192,224,96,0,10,194,48,194,224,194,192,135,128,0,224,124,31,3,0,77,130,1,0,10,194,192,140,216,249,251,190,166,192,216,252,62,91,25,0,13,130,55,119,194,119,137,55,48,112,227,123,203,7,3,0,89,194,3,134,51,49,29,15,7,1,194,1,131,15,12,0,20,194,127,131,15,14,0,11,
    // Frame: 24
    36,194,32,141,48,144,144,216,216,88,88,120,120,248,228,36,0,12,194,192,141,207,190,24,0,112,248,184,156,12,4,6,2,0,86,130,2,0,22,143,16,24,28,12,14,7,3,1,7,14,31,61,113,192,0,8,195,128,194,192,134,131,127,60,96,224,0,10,194,48,194,96,194,192,130,128,0,4,130,128,0,90,142,24,56,56,121,91,11,11,39,241,212,30,3,3,0,11,130,48,112,194,112,138,48,63,255,60,76,244,255,195,192,0,98,131,15,12,0,16,142,7,15,15,7,124,126,3,7,6,12,24,48,96,0,6,
    // Frame: 25
    3,134,62,60,28,156,220,252,195,252,194,248,195,240,196,248,198,252,195,248,144,216,136,136,216,240,240,248,120,56,24,28,28,14,14,12,0,23,194,4,135,6,134,230,118,63,15,6,194,6,130,4,0,8,194,192,133,224,248,60,60,0,34,132,224,248,254,255,215,255,133,236,199,199,239,255,194,255,131,192,128,0,44,194,6,195,14,135,31,127,255,207,14,14,0,35,137,255,127,63,31,31,15,7,7,3,198,3,196,1,13,194,1,194,3,53,194,7,18,133,32,224,192,128,0,121,137,24,28,28,60,185,251,127,60,24,194,24,7,
    // Frame: 26
    3,134,30,28,12,140,204,252,196,252,196,248,204,252,138,126,238,196,196,236,254,239,199,3,0,34,195,1,134,7,31,25,1,1,0,4,131,16,24,56,194,56,133,248,251,255,252,56,194,56,33,194,192,130,248,255,209,255,194,127,195,255,140,254,247,227,99,55,63,127,127,240,224,224,0,49,133,6,15,3,1,0,36,137,251,127,63,31,31,15,7,7,3,196,3,197,1,127,90,131,128,192,224,194,224,135,240,248,248,222,198,128,0,6,
    // Frame: 27
    3,135,30,24,8,12,204,252,248,195,248,196,240,197,248,200,252,133,220,140,136,216,248,194,248,131,28,8,0,37,130,1,0,11,130,1,3,194,3,135,7,15,31,123,227,3,0,30,194,192,130,240,255,214,255,139,252,239,71,71,111,255,255,199,192,128,0,91,137,127,63,31,31,15,15,7,7,3,194,3,207,1,7,195,1,127,75,134,32,96,192,128,128,0,9,
    // Frame: 28
    3,132,120,96,224,240,194,240,194,248,196,252,202,254,195,252,136,124,60,56,112,240,240,224,192,195,192,54,194,6,132,3,1,1,0,32,130,252,255,207,255,197,127,139,255,217,143,143,222,254,255,127,63,15,0,95,194,31,131,15,3,1,197,1,17,133,3,7,15,12,0,127,94,
    // Frame: 29
    5,134,144,248,248,252,254,255,212,255,133,254,252,248,192,0,95,137,240,254,127,31,15,15,7,3,1,194,1,135,128,192,192,97,97,99,255,206,255,107,194,1,4,139,1,31,31,45,54,255,253,252,190,159,31,194,31,131,27,24,0,119,195,1,98,
    // Frame: 30
    3,141,14,15,7,7,3,3,99,115,59,59,63,63,255,206,255,130,252,0,103,194,128,135,192,64,96,96,224,240,255,205,255,131,127,7,0,100,134,128,192,96,64,64,96,194,96,136,248,223,239,255,239,231,247,255,196,255,134,127,63,31,7,3,0,110,139,1,3,6,15,31,127,255,239,207,7,3,194,3,103,
    // Frame: 31
    13,195,1,132,3,7,15,255,198,255,135,254,252,248,240,192,128,0,99,196,128,5,135,128,192,192,224,240,248,255,204,255,99,139,199,193,225,115,127,255,254,126,63,191,255,205,255,133,127,31,15,7,0,99,194,3,136,15,30,115,255,255,127,127,63,197,63,194,31,195,15,132,7,3,1,0,101,
    // Frame: 32
    13,194,128,15,134,195,255,254,252,240,0,95,144,240,252,254,242,255,29,255,254,254,255,247,225,192,128,128,0,4,194,128,194,192,132,224,240,252,255,196,255,130,254,0,94,130,31,255,219,255,133,127,31,15,1,0,96,134,3,7,15,31,31,63,195,63,197,127,196,63,194,31,194,15,133,7,3,3,1,0,96,
    // Frame: 33
    3,130,254,255,203,255,132,254,24,24,0,111,205,255,130,3,0,113,130,127,255,203,255,133,252,240,224,128,0,111,138,1,3,7,15,31,63,63,127,127,255,200,255,130,254,126,195,126,134,62,31,15,7,3,0,95,
    // Frame: 34
    3,206,255,133,248,56,56,16,0,109,206,255,133,127,112,112,96,0,109,203,255,130,131,0,115,133,1,15,63,127,255,199,255,130,240,0,111,
    // Frame: 35
    1,131,192,254,255,203,255,132,254,252,240,0,110,210,255,110,204,255,130,63,255,196,255,134,220,204,204,136,128,0,104,130,63,255,195,255,136,63,7,1,1,3,7,5,7,194,7,133,3,1,0,0,1,194,1,105,
    // Frame: 36
    1,131,240,254,255,204,255,131,252,240,0,109,130,240,255,208,255,130,240,0,108,133,127,255,255,127,255,206,255,110,194,3,136,0,255,255,207,127,247,251,255,196,255,134,127,63,55,49,32,0,107,
    // Frame: 37
    1,131,224,252,255,206,255,131,254,240,0,107,130,192,255,210,255,108,194,15,131,1,63,255,205,255,131,31,3,0,110,136,15,63,243,159,255,253,254,255,194,255,137,127,63,31,15,12,28,28,24,0,106,
};
static const char frame_sizes[] = {
    52,19,73,99,93,68,105,115,142,143,136,112,111,150,125,100,99,139,115,113,120,130,136,146,136,139,114,95,73,65,81,77,81,56,37,56,51,53,
};
static const char diff_frames[] = {
    1,8,11,12,14,15,16,18,19,20,21,22,23,24,
};
static const uint32_t diff_frames_mask =
      (1ul << 1)
    | (1ul << 8)
    | (1ul << 11)
    | (1ul << 12)
    | (1ul << 14)
    | (1ul << 15)
    | (1ul << 16)
    | (1ul << 18)
    | (1ul << 19)
    | (1ul << 20)
    | (1ul << 21)
    | (1ul << 22)
    | (1ul << 23)
    | (1ul << 24);


static uint8_t n_frames = sizeof(frame_sizes) / sizeof(frame_sizes[0]);

oled_rotation_t oled_init_kb(oled_rotation_t rotation) {
    return OLED_ROTATION_0;
    // return OLED_ROTATION_270;
}


// void draw_hand_trim(uint8_t x) {
//     static const char PROGMEM outline[] = {
//         /*255,255,*/227,221, 62,254,253,251,247,239,223,191,127,/*255,255,*/ // 11
//         /*255,255,*/127,129,254,254,254,  1,255,255,255,255,254,113,143,     // 13
//         225, 30,255,255,255,255,255,255,255,255,255,255,207, 48,/*255,*/     // 13
//     };
//     static const char PROGMEM fill[] = {
//           /*0,  0,*/  0, 28, 62,254,252,248,240,224,192,128,  0,/*  0,  0,*/
//           /*0,  0,*/  0,128,254,254,254,  1,255,255,255,255,254,112,  0,
//           0, 30,255,255,255,255,255,255,255,255,255,255,207,  0,/*  0,*/
//     };
//
//     for (uint8_t i = 0; i < 11; i++) {
//         uint8_t oval = pgm_read_byte(&outline[i]);
//         uint8_t fval = pgm_read_byte(&fill[i]);
//
//         uint16_t idx = x + 128*1 + i + 2;
//         uint8_t orig = oled_read_raw_byte(idx);
//         oled_write_raw_byte((orig & oval) | fval, idx);
//     }
//     for (uint8_t i = 0; i < 13; i++) {
//         uint8_t oval = pgm_read_byte(&outline[i + 11]);
//         uint8_t fval = pgm_read_byte(&fill[i + 11]);
//
//         uint16_t idx = x + 128*2 + i + 2;
//         uint8_t orig = oled_read_raw_byte(idx);
//         oled_write_raw_byte((orig & oval) | fval, idx);
//     }
//     for (uint8_t i = 0; i < 13; i++) {
//         uint8_t oval = pgm_read_byte(&outline[i + 11 + 13]);
//         uint8_t fval = pgm_read_byte(&fill[i + 11 + 13]);
//
//         uint16_t idx = x + 128*3 + i;
//         uint8_t orig = oled_read_raw_byte(idx);
//         oled_write_raw_byte((orig & oval) | fval, idx);
//     }
// }

void draw_hand_naive(uint8_t x) {
    static const char PROGMEM outline[] = {
        255,255,227,221, 62,254,253,251,247,239,223,191,127,255,255,
        255,255,127,129,254,254,254,  1,255,255,255,255,254,113,143,
        225, 30,255,255,255,255,255,255,255,255,255,255,207, 48,255,
    };
    static const char PROGMEM fill[] = {
          0,  0,  0, 28, 62,254,252,248,240,224,192,128,  0,  0,  0,
          0,  0,  0,128,254,254,254,  1,255,255,255,255,254,112,  0,
          0, 30,255,255,255,255,255,255,255,255,255,255,207,  0,  0,
    };

    for (uint8_t j = 0; j < 3; j++) {
        for (uint8_t i = 0; i < 15; i++) {
            size_t i_idx = i + 15*j;
            uint8_t oval = pgm_read_byte(&outline[i_idx]);
            uint8_t fval = pgm_read_byte(&fill[i_idx]);

            uint16_t o_idx = x + 128*(j+1) + i;
            uint8_t orig = oled_read_raw_byte(o_idx);
            oled_write_raw_byte((orig & oval) | fval, o_idx);
        }
    }
}

void draw_hand_mask(uint8_t x) {
    static const char PROGMEM mask[] = {
          0,  0, 28, 62,255,255,254,252,248,240,224,192,128,  0,  0,
          0,  0,128,254,255,255,255,255,255,255,255,255,255,254,112,
         30,223,255,255,255,255,255,255,255,255,255,255,255,207,  0,
    };

    static const char PROGMEM img[] = {
          0,  0,  0, 28, 62,254,252,248,240,224,192,128,  0,  0,  0,
          0,  0,  0,128,254,254,254,  1,255,255,255,255,254,112,  0,
        224, 30,255,255,255,255,255,255,255,255,255,255,207,  0,  0,
    };

    for (uint8_t j = 0; j < 3; j++) {
        for (uint8_t i = 0; i < 15; i++) {
            uint8_t mval = pgm_read_byte(&mask[i + 15*j]);
            uint8_t ival = pgm_read_byte(&img[i + 15*j]);

            uint16_t idx = x + 128*(j+1) + i;
            uint8_t orig = oled_read_raw_byte(idx);
            oled_write_raw_byte((ival & mval) | (orig & ~mval), idx);
        }
    }
}

void draw_frame_raw(const char* frame, uint8_t frame_size, bool is_diff_frame) {
    uint16_t cursor = 0;
    uint16_t i = 0;
    while (i < frame_size) {
        uint8_t ctrl = pgm_read_byte(&frame[i]);
        i += 1;

        if ((ctrl >> 7) == 0) {
            // black: lower 7 bits are count
            uint8_t count = ctrl & 0x7F;
            for (uint16_t j = 0; j < (uint16_t)count; ++j) {
                if (!is_diff_frame) {
                    oled_write_raw_byte(0, cursor);
                }
                cursor++;
            }
        } else {
            // bit 7 is set, check bit 6
            uint8_t val = ctrl & 0x3F;  // lower 6 bits
            if ((ctrl >> 6) == 0b10) {
                // raw: next val bytes are copied as-is
                if (!is_diff_frame) {
                    oled_set_cursor_exact(cursor);
                    oled_write_raw_P(&frame[i], val);
                    cursor += val;
                    i += val;
                } else {
                    for (uint8_t j = 0; j < val; j++) {
                        uint8_t v = pgm_read_byte(&frame[i]);
                        uint8_t prev = oled_read_raw_byte(cursor);
                        oled_write_raw_byte(prev ^ v, cursor);
                        cursor++;
                        i++;
                    }
                }
            } else {
                // 0b11: RLE - next byte repeated val times
                uint8_t v = pgm_read_byte(&frame[i]);
                i += 1;
                for (uint8_t j = 0; j < val; ++j) {
                    if (!is_diff_frame) {
                        oled_write_raw_byte(v, cursor);
                    } else {
                        uint8_t prev = oled_read_raw_byte(cursor);
                        oled_write_raw_byte(prev ^ v, cursor);
                    }
                    cursor++;
                }
            }
        }
    }
}

void draw_frame(uint8_t frame_i) {
    const uint8_t frame_size = frame_sizes[frame_i];

    size_t frame_start = 0;
    for (uint8_t j = 0; j < frame_i; j++) {
        frame_start += frame_sizes[j];
    }

    bool is_diff_frame = false;
    for (uint8_t j = 0; j < sizeof(diff_frames); j++) {
        if (diff_frames[j] == frame_i) {
            is_diff_frame = true;
            break;
        }
    }

    // bool is_diff_frame = (diff_frames_mask & (1 << frame_i)) != 0;

    draw_frame_raw(&frames[frame_start], frame_size, is_diff_frame);
}

static uint32_t timer = 0;
static uint8_t pets_remaining = 0;
static uint32_t pet_start = 0;
// static uint32_t delay = 0;
static uint8_t prev_frame_i = 255;
static uint8_t frame_i = 0;

enum State {
    Sleeping,
    GoingToSleep,
    Awake,
    Petting,
} state = Sleeping;


// void render_v3(void) {
//     const bool typing = get_current_wpm() > 0;
//     const uint32_t time = timer_read32();
//
//     if (frame_i != prev_frame_i || state == Petting) {
//         draw_frame(frame_i);
//         prev_frame_i = frame_i;
//     }
//
//     switch (state) {
//         case Petting: {
//             uint32_t t = TIMER_DIFF_32(time, pet_start) / 2;
//
//             if (t >= 255) {
//                 if (!--pets_remaining) {
//                     state = Sleeping;
//                 } else {
//                     pet_start = time;
//                 }
//             } else {
//                 draw_hand_mask(10 + cos8(t) / 32);
//             }
//         } break;
//
//         case Sleeping: {
//             if (pets_remaining) {
//                 state = Petting;
//                 pet_start = time;
//             } else if (typing) {
//                 state = Awake;
//             }
//         } break;
//
//         case GoingToSleep: {
//             if (TIMER_DIFF_32(time, timer) > 50) {
//                 if (++frame_i >= n_frames) {
//                     frame_i = 0;
//                     state = Sleeping;
//                 }
//                 timer = time;
//             }
//         } break;
//
//         case Awake: {
//             if (TIMER_DIFF_32(time, timer) > (frame_i == 1 ? 500 : 50)) {
//                 if (++frame_i >= n_frames) frame_i = 0;
//                 if (frame_i == 25) frame_i = 9;
//                 if (!typing || pets_remaining) state = GoingToSleep;
//                 timer = time;
//             }
//         } break;
//     }
// }

void render_v2(void) {
    const bool typing = get_current_wpm() > 0;
    const uint32_t time = timer_read32();
    const uint32_t time_diff = TIMER_DIFF_32(time, timer);

    if (frame_i != prev_frame_i || state == Petting) {
        draw_frame(frame_i);
        prev_frame_i = frame_i;
    }

    switch (state) {

        case Petting: {
            const uint32_t t = TIMER_DIFF_32(time, pet_start);

            if (t >= 255) {
                pets_remaining--;
                pet_start = time;
            }
            if (!pets_remaining) {
                state = Sleeping;
            } else {
                draw_hand_naive(10 + cos8(t) / 32);
            }

        } break;

        case Sleeping: {
            if (typing) {
                state = Awake;
            }
            if (pets_remaining) {
                state = Petting;
                pet_start = time;
                // pet_start = timer_read32();
            }
        } break;

        case GoingToSleep: {
            if (time_diff > 50) {
                frame_i++;
                if (frame_i >= n_frames) {
                    frame_i = 0;
                    state = Sleeping;
                }

                timer = time;
            }
        } break;

        case Awake: {
            if (time_diff > (frame_i == 1 ? 500 : 50)) {

                frame_i++;
                if (frame_i >= n_frames) frame_i = 0;
                if (frame_i == 25) frame_i = 9;
                if (!typing || pets_remaining) state = GoingToSleep;
                timer = time;
            }
        } break;
    }
}


// __attribute__((weak)) void render(void) {
//
//     const uint32_t time = timer_read32();
//     // const bool typing = TIMER_DIFF_32(time, idle_timer) < 4000;
//     const bool typing = get_current_wpm() > 0;
//
//     if (
//         !(frame_i == 1 && (!typing || pets_remaining))
//         // (typing || !petting || frame_i != 1)
//         && TIMER_DIFF_32(time, timer) > delay
//     ) {
//         const uint8_t frame_size = frame_sizes[frame_i];
//         size_t frame_start = 0;
//         for (uint8_t j = 0; j < frame_i; j++) {
//             frame_start += frame_sizes[j];
//         }
//
//         bool is_diff_frame = false;
//         for (uint8_t j = 0; j < sizeof(diff_frames); j++) {
//             if (diff_frames[j] == frame_i) {
//                 is_diff_frame = true;
//                 break;
//             }
//         }
//
//         draw_frame_raw(&frames[frame_start], frame_size, is_diff_frame);
//
//         if (frame_i == 1) {
//             delay = 500;
//         } else {
//             delay = 50;
//         }
//
//         frame_i = (frame_i + 1) % n_frames;
//         if (frame_i == 25 && typing) {
//             frame_i = 9;
//         }
//
//         timer = timer_read32();
//     }
//     else if (pets_remaining) {
//         draw_frame_raw(&frames[0], frame_sizes[0], false);
//         draw_hand_mask(10 + sin8(timer_read32()) / 32);
//     }
// }



bool process_record_kb(uint16_t keycode, keyrecord_t *record) {
    if (record->event.pressed) {
        if (keycode == OL_PET) {
            pets_remaining++;
            return true;
        }

    }
    return true;
}

bool oled_task_kb(void) {
    render_v2();
    return false;
}

